#!/bin/bash
set -euo pipefail
here=$(dirname "${BASH_SOURCE[0]}")

if [ $# -ne 1 ]; then
  echo >&2 "usage: $0 outputdir"
  exit 1
fi
out=$1

buildtool() {
  local tool
  tool=$1
  path=$(type -ap "$tool" |head -n1)
  ln -s "$path" "$out/build-tools/bin/$tool"
}

stdenv=()

stdtool() {
  stdenv+=("$out/$1")
}

package() {
  local module
  module=$1
  shift
  "$here"/build "$out/$module" "$here/module/$module" \
    "${stdenv[@]}" "${@/#/$out/}"
}

rm -rf "$out"/build-tools
mkdir -p "$out"/build-tools/bin

. "$here"/packages
