#!/bin/bash
set -euo pipefail
here=$(dirname "${BASH_SOURCE[0]}")

if [ $# -ne 1 ]; then
  echo >&2 "usage: $0 outputdir"
  exit 1
fi
out=$1

stdenv=("$out"/build-tools)

stdtool() {
  stdenv+=("$out/$1")
}

package() {
  local module
  module=$1
  shift
  "$here"/build "$out/$module" "$here/module/$module" \
    "${stdenv[@]}" "${@/#/$out/}"
}

rm -rf "$out"/build-tools
mkdir -p "$out"/build-tools/bin
while read -r tool; do
  path=$(type -ap "$tool" |head -n1)
  ln -s "$path" "$out/build-tools/bin/$tool"
done < "$here"/build-tools

. "$here"/packages
